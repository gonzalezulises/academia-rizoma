# =============================================================================
# CAP√çTULO 1: ORGANIGRAMA VS RED INFORMAL
# Aplicaci√≥n del Modelo 4C √ó Bloom
# Duraci√≥n target: 25 minutos
# Audiencia: Gerentes y profesionales de RRHH en LATAM
# =============================================================================

id: lesson-01-organigrama-vs-red
title: "El organigrama vs. la red real"
slug: organigrama-vs-red-informal

# Metadatos pedag√≥gicos
pedagogyMeta:
  model: "4C-Bloom"
  totalDuration: 25
  structure:
    connection:
      percent: 10
      minutes: 2.5
      description: "Activaci√≥n de conocimiento previo"
    construction:
      percent: 55
      minutes: 14
      description: "Contenido expositivo + ejercicios interactivos"
    consolidation:
      percent: 25
      minutes: 6
      description: "Quiz de verificaci√≥n"
    conclusions:
      percent: 10
      minutes: 2.5
      description: "S√≠ntesis y transferencia"
  bloomLevels:
    - remember: 20%
    - understand: 40%
    - apply: 40%

# Objetivos de aprendizaje expl√≠citos (Bloom taxonomy)
learningObjectives:
  - id: LO1
    verb: "Distinguir"
    level: understand
    description: "Distinguir entre la estructura formal (organigrama) y la estructura informal (red de relaciones)"
  - id: LO2
    verb: "Identificar"
    level: apply
    description: "Identificar qu√© preguntas organizacionales puede responder ONA que el organigrama no puede"
  - id: LO3
    verb: "Reconocer"
    level: understand
    description: "Reconocer el rol y la importancia de un broker en una red organizacional"

# =============================================================================
# BLOQUE 1: CONNECTION (10% ~ 2.5 min)
# Tipo: Misconception Check - Predicci√≥n antes de aprender
# =============================================================================
connection:
  type: misconception_check
  title: "¬øQu√© tanto conoces sobre c√≥mo funcionan realmente las organizaciones?"

  introduction: |
    Antes de comenzar, prueba tu intuici√≥n sobre redes organizacionales.

    Para cada afirmaci√≥n, indica si crees que es **Verdadera** o **Falsa**.
    No te preocupes si no est√°s seguro: esto es precisamente para descubrir
    qu√© tan bien predice nuestro sentido com√∫n la realidad de las organizaciones.

  statements:
    - id: MC1
      text: "La persona m√°s consultada de una organizaci√≥n siempre tiene un cargo gerencial o directivo."
      studentPredict: null  # V o F - el estudiante predice
      correct: false
      explanation: |
        ‚ùå **Falso.** Las investigaciones en ONA muestran consistentemente que los
        "expertos ocultos" a menudo est√°n en posiciones medias o t√©cnicas.
        La influencia informal rara vez coincide con la jerarqu√≠a formal.

    - id: MC2
      text: "Si dos departamentos aparecen conectados en el organigrama (por ejemplo, comparten un director), en la pr√°ctica colaboran frecuentemente."
      studentPredict: null
      correct: false
      explanation: |
        ‚ùå **Falso.** El organigrama muestra relaciones de reporte, no de colaboraci√≥n.
        Dos departamentos bajo el mismo VP pueden operar como silos completos.
        ONA revela estas desconexiones ocultas.

    - id: MC3
      text: "Cuando una persona clave renuncia, la organizaci√≥n generalmente sabe exactamente qu√© conocimiento se pierde."
      studentPredict: null
      correct: false
      explanation: |
        ‚ùå **Falso.** El conocimiento informal (a qui√©n consultar, c√≥mo navegar
        procesos, relaciones con clientes) es invisible hasta que se pierde.
        ONA puede mapear este riesgo antes de que ocurra.

    - id: MC4
      text: "Las redes informales pueden mapearse y medirse de forma sistem√°tica."
      studentPredict: null
      correct: true
      explanation: |
        ‚úÖ **Verdadero.** ONA (Organizational Network Analysis) es una metodolog√≠a
        establecida con m√©tricas cuantitativas. No es intuici√≥n ni pol√≠tica de oficina:
        es ciencia de redes aplicada a organizaciones.

  debrief: |
    Si acertaste 3 o m√°s, tu intuici√≥n sobre organizaciones es s√≥lida.
    Si acertaste menos, no te preocupes: este cap√≠tulo te dar√° herramientas
    para ver lo que antes era invisible.

    **Dato revelador:** En un estudio de McKinsey, solo el 35% de los ejecutivos
    pod√≠a identificar correctamente qui√©nes eran los conectores clave de su organizaci√≥n.
    El otro 65% asum√≠a que coincid√≠an con la jerarqu√≠a formal.

# =============================================================================
# BLOQUE 2: CONSTRUCTION - CONTENIDO EXPOSITIVO
# (El contenido actual del MD se mantiene aqu√≠)
# =============================================================================
construction:
  content_file: "01-organigrama-vs-red.md"  # El contenido expositivo actual se mantiene

  # Los ejercicios se embeben en posiciones espec√≠ficas del contenido
  exercises:
    - embed_after: "caso-manufactura"
      exercise_id: "ex-01-detectar-red"
    - embed_after: "rol-broker"
      exercise_id: "ex-02-identificar-broker"

# =============================================================================
# EJERCICIO 1 MEJORADO: DETECTAR LA RED OCULTA
# Datos: Manufactura Regional - 120 empleados, 3 departamentos
# =============================================================================
exercises:
  - id: ex-01-detectar-red-v2
    type: code-python
    title: "Detectando la red oculta"
    description: "Compara el organigrama formal con la red informal de consultas en Manufactura Regional."

    instructions: |
      ## Caso: Manufactura Regional

      Est√°s analizando una planta de manufactura con **120 empleados** en **3 departamentos**:
      - **Producci√≥n** (60 personas): L√≠nea de ensamble, supervisores, t√©cnicos
      - **Calidad** (35 personas): Inspecci√≥n, an√°lisis, documentaci√≥n
      - **Log√≠stica** (25 personas): Almac√©n, despacho, planeaci√≥n

      Se realiz√≥ una encuesta preguntando: *"¬øA qui√©n consultas cuando tienes un problema t√©cnico dif√≠cil?"*

      **Observa las dos visualizaciones:**
      - **Izquierda**: Fragmento del organigrama formal (jerarqu√≠a de reporte)
      - **Derecha**: Red de consultas t√©cnicas (qui√©n consulta a qui√©n)

      Los colores indican departamento:
      - üîµ Azul = Producci√≥n
      - üü¢ Verde = Calidad
      - üü† Naranja = Log√≠stica

      El **tama√±o del nodo** indica cu√°ntas personas consultan a esa persona.

    difficulty: beginner
    estimated_time_minutes: 7
    points: 30
    order: 1

    required_packages:
      - networkx
      - matplotlib
      - numpy

    ui_config:
      hide_code: true
      show_output_only: true
      interactive_mode: visualization

    # C√≥digo completo y funcional
    starter_code: |
      import networkx as nx
      import matplotlib.pyplot as plt
      import numpy as np

      # ===========================================
      # DATOS: Manufactura Regional (120 empleados)
      # ===========================================

      # --- ORGANIGRAMA (estructura jer√°rquica simplificada) ---
      # Solo mostramos 15 nodos representativos para claridad visual
      org_nodes = {
          # Direcci√≥n
          "Dir. Planta": {"dept": "direccion", "level": 0},
          # Gerentes
          "Gte. Producci√≥n": {"dept": "produccion", "level": 1},
          "Gte. Calidad": {"dept": "calidad", "level": 1},
          "Gte. Log√≠stica": {"dept": "logistica", "level": 1},
          # Supervisores/Jefes
          "Sup. L√≠nea A": {"dept": "produccion", "level": 2},
          "Sup. L√≠nea B": {"dept": "produccion", "level": 2},
          "Jefe QA": {"dept": "calidad", "level": 2},
          "Jefe Documentaci√≥n": {"dept": "calidad", "level": 2},
          "Jefe Almac√©n": {"dept": "logistica", "level": 2},
          # T√©cnicos/Analistas clave
          "T√©cnico Senior": {"dept": "produccion", "level": 3},
          "Operador A1": {"dept": "produccion", "level": 3},
          "Analista QA Sr.": {"dept": "calidad", "level": 3},
          "Inspector 1": {"dept": "calidad", "level": 3},
          "Coord. Despacho": {"dept": "logistica", "level": 3},
          "Almacenista Sr.": {"dept": "logistica", "level": 3},
      }

      org_edges = [
          ("Dir. Planta", "Gte. Producci√≥n"),
          ("Dir. Planta", "Gte. Calidad"),
          ("Dir. Planta", "Gte. Log√≠stica"),
          ("Gte. Producci√≥n", "Sup. L√≠nea A"),
          ("Gte. Producci√≥n", "Sup. L√≠nea B"),
          ("Gte. Calidad", "Jefe QA"),
          ("Gte. Calidad", "Jefe Documentaci√≥n"),
          ("Gte. Log√≠stica", "Jefe Almac√©n"),
          ("Sup. L√≠nea A", "T√©cnico Senior"),
          ("Sup. L√≠nea A", "Operador A1"),
          ("Jefe QA", "Analista QA Sr."),
          ("Jefe QA", "Inspector 1"),
          ("Jefe Almac√©n", "Coord. Despacho"),
          ("Jefe Almac√©n", "Almacenista Sr."),
      ]

      # --- RED DE CONSULTAS (qui√©n consulta a qui√©n) ---
      # El "Analista QA Sr." resulta ser el m√°s consultado
      network_edges = [
          # Consultas HACIA el Analista QA Sr. (el "experto oculto")
          ("Sup. L√≠nea A", "Analista QA Sr."),
          ("Sup. L√≠nea B", "Analista QA Sr."),
          ("T√©cnico Senior", "Analista QA Sr."),
          ("Operador A1", "Analista QA Sr."),
          ("Jefe Almac√©n", "Analista QA Sr."),
          ("Coord. Despacho", "Analista QA Sr."),
          ("Inspector 1", "Analista QA Sr."),
          ("Gte. Producci√≥n", "Analista QA Sr."),
          ("Jefe Documentaci√≥n", "Analista QA Sr."),
          # Consultas internas Producci√≥n
          ("Operador A1", "T√©cnico Senior"),
          ("Sup. L√≠nea B", "Sup. L√≠nea A"),
          # Consultas internas Log√≠stica
          ("Almacenista Sr.", "Coord. Despacho"),
          # Cross-departamento v√≠a T√©cnico Senior
          ("Coord. Despacho", "T√©cnico Senior"),
          # Jefe QA consulta a su propio subordinado (el experto real)
          ("Jefe QA", "Analista QA Sr."),
      ]

      # Colores por departamento
      dept_colors = {
          "direccion": "#95a5a6",  # Gris
          "produccion": "#3498db",  # Azul
          "calidad": "#2ecc71",     # Verde
          "logistica": "#e67e22",   # Naranja
      }

      # ===========================================
      # VISUALIZACI√ìN COMPARATIVA
      # ===========================================
      fig, axes = plt.subplots(1, 2, figsize=(16, 8))

      # --- GR√ÅFICO 1: ORGANIGRAMA ---
      G_org = nx.DiGraph()
      G_org.add_edges_from(org_edges)

      # Posiciones jer√°rquicas
      pos_org = {}
      level_count = {0: 0, 1: 0, 2: 0, 3: 0}
      level_max = {0: 1, 1: 3, 2: 5, 3: 6}

      for node, attrs in org_nodes.items():
          level = attrs["level"]
          y = 3 - level  # Invertir para que Director est√© arriba
          x = level_count[level] - (level_max[level] - 1) / 2
          pos_org[node] = (x * 1.5, y * 1.2)
          level_count[level] += 1

      node_colors_org = [dept_colors[org_nodes[n]["dept"]] for n in G_org.nodes()]

      nx.draw(G_org, pos_org, ax=axes[0],
              with_labels=True,
              node_color=node_colors_org,
              node_size=1800,
              font_size=7,
              font_weight='bold',
              arrows=True,
              arrowsize=15,
              edge_color='#bdc3c7',
              width=1.5)
      axes[0].set_title("ORGANIGRAMA FORMAL\n(Qui√©n reporta a qui√©n)",
                        fontsize=14, fontweight='bold', pad=20)

      # --- GR√ÅFICO 2: RED DE CONSULTAS ---
      G_net = nx.Graph()
      G_net.add_nodes_from(org_nodes.keys())
      G_net.add_edges_from(network_edges)

      # Calcular grados para tama√±o de nodos
      degrees = dict(G_net.degree())
      max_degree = max(degrees.values())
      node_sizes = [800 + (degrees[n] / max_degree) * 2500 for n in G_net.nodes()]

      # Colores - resaltar al m√°s consultado
      node_colors_net = []
      for n in G_net.nodes():
          if degrees[n] == max_degree:
              node_colors_net.append("#e74c3c")  # Rojo para el m√°s consultado
          else:
              node_colors_net.append(dept_colors[org_nodes[n]["dept"]])

      # Layout basado en grado (los m√°s consultados al centro)
      pos_net = nx.spring_layout(G_net, k=2.5, iterations=50, seed=42)

      nx.draw(G_net, pos_net, ax=axes[1],
              with_labels=True,
              node_color=node_colors_net,
              node_size=node_sizes,
              font_size=7,
              font_weight='bold',
              edge_color='#bdc3c7',
              width=1.5,
              alpha=0.9)
      axes[1].set_title("RED DE CONSULTAS T√âCNICAS\n(Qui√©n consulta a qui√©n)",
                        fontsize=14, fontweight='bold', pad=20)

      # Leyenda
      legend_elements = [
          plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#3498db',
                     markersize=12, label='Producci√≥n'),
          plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#2ecc71',
                     markersize=12, label='Calidad'),
          plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#e67e22',
                     markersize=12, label='Log√≠stica'),
          plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#e74c3c',
                     markersize=15, label='M√°s consultado'),
      ]
      fig.legend(handles=legend_elements, loc='lower center', ncol=4,
                 fontsize=10, frameon=True, fancybox=True)

      plt.tight_layout(rect=[0, 0.08, 1, 1])
      plt.show()

      # ===========================================
      # M√âTRICAS CLAVE (para verificaci√≥n)
      # ===========================================
      print("\n" + "="*60)
      print("üìä M√âTRICAS DE LA RED DE CONSULTAS")
      print("="*60)

      # Top 5 m√°s consultados
      top_consultados = sorted(degrees.items(), key=lambda x: x[1], reverse=True)[:5]
      print("\nüîù Top 5 personas m√°s consultadas:")
      for i, (nombre, grado) in enumerate(top_consultados, 1):
          dept = org_nodes[nombre]["dept"].capitalize()
          level = org_nodes[nombre]["level"]
          nivel_org = ["Director", "Gerente", "Jefe/Supervisor", "T√©cnico/Analista"][level]
          marker = "üî¥" if i == 1 else "  "
          print(f"   {marker} {i}. {nombre} ({dept}) - {grado} consultas - Nivel: {nivel_org}")

      # Calcular betweenness para el broker
      betweenness = nx.betweenness_centrality(G_net)
      top_broker = max(betweenness.items(), key=lambda x: x[1])

      print(f"\nüîó Mayor intermediaci√≥n (broker potencial):")
      print(f"   ‚Üí {top_broker[0]} (betweenness: {top_broker[1]:.3f})")

    solution_code: |
      # RESPUESTAS CORRECTAS:
      #
      # 1. Persona m√°s consultada: "Analista QA Sr." (9 conexiones)
      #    - En el organigrama est√° en nivel 3 (el m√°s bajo mostrado)
      #    - Reporta al Jefe QA, que reporta al Gte. Calidad
      #    - Sin embargo, es consultado por TODOS los departamentos
      #
      # 2. Diferencia jer√°rquica vs red:
      #    - Organigrama: Analista QA Sr. est√° 3 niveles abajo del Director
      #    - Red real: Es el nodo m√°s central y conectado
      #
      # 3. Riesgo si se va:
      #    - Producci√≥n perder√≠a su fuente de conocimiento t√©cnico de calidad
      #    - Log√≠stica perder√≠a consultas sobre especificaciones
      #    - El Jefe QA perder√≠a a quien realmente resuelve los problemas
      #    - NADIE en el organigrama lo identificar√≠a como cr√≠tico

    # Tests con assertions que validan comprensi√≥n
    test_cases:
      - id: test-identify-most-consulted
        name: "Identificar persona m√°s consultada"
        description: "El estudiante debe identificar al Analista QA Sr. como el m√°s consultado"
        test_code: |
          # Verificar que el estudiante identifica correctamente al m√°s consultado
          G = nx.Graph()
          G.add_edges_from(network_edges)
          degrees = dict(G.degree())
          most_consulted = max(degrees.items(), key=lambda x: x[1])
          assert most_consulted[0] == "Analista QA Sr.", \
              f"El m√°s consultado es 'Analista QA Sr.', no '{most_consulted[0]}'"
          assert most_consulted[1] >= 9, \
              f"Debe tener al menos 9 conexiones, tiene {most_consulted[1]}"
        points: 10

      - id: test-hierarchy-gap
        name: "Detectar brecha jerarqu√≠a vs influencia"
        description: "El estudiante debe reconocer que el m√°s consultado NO es un gerente"
        test_code: |
          # Verificar que el m√°s consultado est√° en nivel bajo del organigrama
          most_consulted = "Analista QA Sr."
          org_level = org_nodes[most_consulted]["level"]
          assert org_level == 3, \
              f"El Analista QA Sr. est√° en nivel {org_level}, el m√°s bajo (3)"
          # Verificar que su jefe lo consulta (inversi√≥n de jerarqu√≠a)
          assert ("Jefe QA", "Analista QA Sr.") in network_edges, \
              "El Jefe QA consulta a su subordinado - inversi√≥n jer√°rquica"
        points: 10

      - id: test-cross-department
        name: "Identificar consultas cross-departamento"
        description: "El estudiante debe notar que Producci√≥n y Log√≠stica consultan a Calidad"
        test_code: |
          # Contar cu√°ntos departamentos consultan al Analista QA Sr.
          consultantes = [e[0] for e in network_edges if e[1] == "Analista QA Sr."]
          depts_consultantes = set([org_nodes[c]["dept"] for c in consultantes])
          assert "produccion" in depts_consultantes, \
              "Producci√≥n debe consultar al Analista QA Sr."
          assert "logistica" in depts_consultantes, \
              "Log√≠stica debe consultar al Analista QA Sr."
          assert len(depts_consultantes) >= 3, \
              f"Al menos 3 departamentos consultan al experto, encontrados: {depts_consultantes}"
        points: 10

    # Hints progresivos
    hints:
      - level: 1
        text: "Observa el nodo marcado en ROJO en la red de consultas. ¬øCu√°ntas l√≠neas llegan a √©l?"
      - level: 2
        text: "Ahora busca ese mismo nombre en el organigrama de la izquierda. ¬øEn qu√© nivel est√°? ¬øArriba con los gerentes o abajo con los t√©cnicos?"
      - level: 3
        text: "F√≠jate que personas de TODOS los colores (departamentos) consultan al nodo rojo. Incluso su propio jefe. ¬øQu√© te dice esto sobre el poder real vs el poder formal?"

    tags:
      - ona
      - visualizacion
      - organigrama
      - red-informal
      - experto-oculto

    concepts:
      - red-informal
      - estructura-formal
      - experto-oculto
      - centralidad-grado

  # ==========================================================================
  # EJERCICIO 2 MEJORADO: IDENTIFICAR AL BROKER
  # ==========================================================================
  - id: ex-02-identificar-broker-v2
    type: code-python
    title: "Identificando al broker"
    description: "Encuentra qui√©n conecta departamentos que de otra forma estar√≠an aislados."

    instructions: |
      ## El problema de los silos

      Continuando con Manufactura Regional, la encuesta tambi√©n pregunt√≥:
      *"¬øCon qui√©n de OTROS departamentos te comunicas al menos una vez por semana?"*

      Los resultados revelaron un problema: **sin ciertas personas clave, los
      departamentos quedar√≠an completamente aislados**.

      **Tu tarea:** Analiza la red y responde:
      1. ¬øQui√©n es el broker principal (conecta m√°s departamentos)?
      2. ¬øQu√© pasar√≠a si esa persona se fuera?
      3. ¬øLa organizaci√≥n sabe que esta persona es cr√≠tica?

      üìå **Definici√≥n de broker:** Persona con alta *intermediaci√≥n* (betweenness) -
      muchos caminos entre otros nodos pasan por ella.

    difficulty: beginner
    estimated_time_minutes: 7
    points: 30
    order: 2

    required_packages:
      - networkx
      - matplotlib

    ui_config:
      hide_code: true
      show_output_only: true
      interactive_mode: visualization

    starter_code: |
      import networkx as nx
      import matplotlib.pyplot as plt
      import numpy as np

      # ===========================================
      # DATOS: Red inter-departamental
      # ===========================================

      # Nodos por departamento (simplificado a 18 personas clave)
      nodes = {
          # Producci√≥n (P)
          "P-Gerente": {"dept": "produccion", "title": "Gte. Producci√≥n"},
          "P-SupA": {"dept": "produccion", "title": "Sup. L√≠nea A"},
          "P-SupB": {"dept": "produccion", "title": "Sup. L√≠nea B"},
          "P-T√©cnico1": {"dept": "produccion", "title": "T√©cnico Senior"},
          "P-T√©cnico2": {"dept": "produccion", "title": "T√©cnico Jr"},
          "P-Operador": {"dept": "produccion", "title": "Operador"},
          # Calidad (Q)
          "Q-Gerente": {"dept": "calidad", "title": "Gte. Calidad"},
          "Q-JefeQA": {"dept": "calidad", "title": "Jefe QA"},
          "Q-Analista": {"dept": "calidad", "title": "Analista QA Sr."},
          "Q-Inspector1": {"dept": "calidad", "title": "Inspector 1"},
          "Q-Inspector2": {"dept": "calidad", "title": "Inspector 2"},
          "Q-Docs": {"dept": "calidad", "title": "Documentaci√≥n"},
          # Log√≠stica (L)
          "L-Gerente": {"dept": "logistica", "title": "Gte. Log√≠stica"},
          "L-JefeAlm": {"dept": "logistica", "title": "Jefe Almac√©n"},
          "L-Coord": {"dept": "logistica", "title": "Coord. Despacho"},
          "L-Planif": {"dept": "logistica", "title": "Planificador"},
          "L-Almac1": {"dept": "logistica", "title": "Almacenista 1"},
          "L-Almac2": {"dept": "logistica", "title": "Almacenista 2"},
      }

      # Conexiones INTERNAS de cada departamento (comunidades densas)
      internal_edges = [
          # Producci√≥n - equipo cohesionado
          ("P-Gerente", "P-SupA"), ("P-Gerente", "P-SupB"),
          ("P-SupA", "P-T√©cnico1"), ("P-SupA", "P-Operador"),
          ("P-SupB", "P-T√©cnico2"), ("P-T√©cnico1", "P-T√©cnico2"),
          ("P-T√©cnico1", "P-Operador"),
          # Calidad - equipo cohesionado
          ("Q-Gerente", "Q-JefeQA"), ("Q-JefeQA", "Q-Analista"),
          ("Q-JefeQA", "Q-Inspector1"), ("Q-Analista", "Q-Inspector1"),
          ("Q-Analista", "Q-Inspector2"), ("Q-Inspector1", "Q-Inspector2"),
          ("Q-Analista", "Q-Docs"), ("Q-Gerente", "Q-Docs"),
          # Log√≠stica - equipo cohesionado
          ("L-Gerente", "L-JefeAlm"), ("L-JefeAlm", "L-Coord"),
          ("L-JefeAlm", "L-Planif"), ("L-Coord", "L-Almac1"),
          ("L-Coord", "L-Almac2"), ("L-Almac1", "L-Almac2"),
          ("L-Planif", "L-Coord"),
      ]

      # Conexiones ENTRE departamentos (pocas - silos)
      cross_dept_edges = [
          # El BROKER: Coord. Despacho conecta los 3 departamentos
          ("L-Coord", "P-SupA"),      # Log√≠stica <-> Producci√≥n
          ("L-Coord", "Q-Inspector1"), # Log√≠stica <-> Calidad
          # Conexi√≥n secundaria (no broker)
          ("P-T√©cnico1", "Q-Analista"), # Producci√≥n <-> Calidad (t√©cnico)
          # Conexi√≥n gerencial (formal, poco usada)
          ("P-Gerente", "Q-Gerente"),
      ]

      all_edges = internal_edges + cross_dept_edges

      # ===========================================
      # CREAR GRAFO Y CALCULAR M√âTRICAS
      # ===========================================
      G = nx.Graph()
      G.add_nodes_from(nodes.keys())
      G.add_edges_from(all_edges)

      # Calcular betweenness centrality (m√©trica de broker)
      betweenness = nx.betweenness_centrality(G)

      # Colores por departamento
      dept_colors = {
          "produccion": "#3498db",  # Azul
          "calidad": "#2ecc71",     # Verde
          "logistica": "#e67e22",   # Naranja
      }

      # Identificar al broker (mayor betweenness)
      broker = max(betweenness.items(), key=lambda x: x[1])
      broker_name = broker[0]

      # ===========================================
      # VISUALIZACI√ìN PRINCIPAL
      # ===========================================
      fig, axes = plt.subplots(1, 2, figsize=(16, 8))

      # --- GR√ÅFICO 1: Red completa con broker resaltado ---
      node_colors = []
      node_sizes = []
      for n in G.nodes():
          if n == broker_name:
              node_colors.append("#e74c3c")  # Rojo para broker
              node_sizes.append(2500)
          else:
              node_colors.append(dept_colors[nodes[n]["dept"]])
              node_sizes.append(1200)

      # Layout que agrupa por departamento
      pos = nx.spring_layout(G, k=2, iterations=100, seed=42)

      # Resaltar conexiones del broker
      edge_colors = []
      edge_widths = []
      for e in G.edges():
          if broker_name in e:
              edge_colors.append("#e74c3c")
              edge_widths.append(3)
          elif e in cross_dept_edges or (e[1], e[0]) in cross_dept_edges:
              edge_colors.append("#f39c12")
              edge_widths.append(2)
          else:
              edge_colors.append("#bdc3c7")
              edge_widths.append(1)

      # Etiquetas simplificadas
      labels = {n: nodes[n]["title"].replace("Gte. ", "").replace("Coord. ", "Coord\n")
                for n in G.nodes()}

      nx.draw(G, pos, ax=axes[0],
              labels=labels,
              node_color=node_colors,
              node_size=node_sizes,
              font_size=7,
              font_weight='bold',
              edge_color=edge_colors,
              width=edge_widths)
      axes[0].set_title("RED INTER-DEPARTAMENTAL\n¬øQui√©n conecta los silos?",
                        fontsize=14, fontweight='bold')

      # --- GR√ÅFICO 2: ¬øQu√© pasa si el broker se va? ---
      G_sin_broker = G.copy()
      G_sin_broker.remove_node(broker_name)

      # Detectar componentes conectados (grupos aislados)
      components = list(nx.connected_components(G_sin_broker))

      # Colores por componente
      component_colors = ['#3498db', '#2ecc71', '#e67e22', '#9b59b6', '#1abc9c']
      node_to_component = {}
      for i, comp in enumerate(components):
          for node in comp:
              node_to_component[node] = i

      node_colors_2 = [component_colors[node_to_component[n] % len(component_colors)]
                       for n in G_sin_broker.nodes()]

      pos_2 = {k: v for k, v in pos.items() if k != broker_name}

      nx.draw(G_sin_broker, pos_2, ax=axes[1],
              labels={n: labels[n] for n in G_sin_broker.nodes()},
              node_color=node_colors_2,
              node_size=1200,
              font_size=7,
              font_weight='bold',
              edge_color='#bdc3c7',
              width=1.5)

      # Marcar d√≥nde estaba el broker
      broker_pos = pos[broker_name]
      axes[1].scatter([broker_pos[0]], [broker_pos[1]], s=2500,
                      facecolors='none', edgecolors='#e74c3c',
                      linewidths=3, linestyles='dashed')
      axes[1].annotate('VACANTE', broker_pos, fontsize=10, ha='center',
                       color='#e74c3c', fontweight='bold')

      n_components = len(components)
      axes[1].set_title(f"SI EL BROKER SE VA...\n({n_components} grupos aislados)",
                        fontsize=14, fontweight='bold', color='#c0392b')

      # Leyenda
      legend_elements = [
          plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#3498db',
                     markersize=12, label='Producci√≥n'),
          plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#2ecc71',
                     markersize=12, label='Calidad'),
          plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#e67e22',
                     markersize=12, label='Log√≠stica'),
          plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#e74c3c',
                     markersize=15, label=f'BROKER: {nodes[broker_name]["title"]}'),
      ]
      fig.legend(handles=legend_elements, loc='lower center', ncol=4,
                 fontsize=10, frameon=True)

      plt.tight_layout(rect=[0, 0.1, 1, 1])
      plt.show()

      # ===========================================
      # AN√ÅLISIS DE IMPACTO
      # ===========================================
      print("\n" + "="*60)
      print("üìä AN√ÅLISIS DE INTERMEDIACI√ìN (BETWEENNESS)")
      print("="*60)

      # Top 5 por betweenness
      top_betweenness = sorted(betweenness.items(), key=lambda x: x[1], reverse=True)[:5]
      print("\nüîó Top 5 personas con mayor intermediaci√≥n:")
      for i, (node, score) in enumerate(top_betweenness, 1):
          dept = nodes[node]["dept"].capitalize()
          title = nodes[node]["title"]
          marker = "üî¥ BROKER ‚Üí" if i == 1 else "          "
          print(f"   {marker} {i}. {title} ({dept}) - Betweenness: {score:.3f}")

      print("\n" + "="*60)
      print("‚ö†Ô∏è  AN√ÅLISIS DE RIESGO")
      print("="*60)
      print(f"\nSi '{nodes[broker_name]['title']}' se va de la empresa:")
      print(f"   ‚Ä¢ La red se fragmenta en {n_components} componentes aislados")

      for i, comp in enumerate(components, 1):
          depts_in_comp = set([nodes[n]["dept"] for n in comp])
          print(f"   ‚Ä¢ Grupo {i}: {len(comp)} personas ({', '.join(depts_in_comp)})")

      print(f"\nüí° Conclusi√≥n: El '{nodes[broker_name]['title']}' es un PUNTO √öNICO DE FALLA")
      print(f"   en la comunicaci√≥n inter-departamental.")

    solution_code: |
      # RESPUESTAS CORRECTAS:
      #
      # 1. ¬øQui√©n es el broker principal?
      #    ‚Üí Coord. Despacho (L-Coord)
      #    ‚Üí Betweenness m√°s alto: ~0.35
      #    ‚Üí Conecta Log√≠stica con Producci√≥n Y con Calidad
      #
      # 2. ¬øQu√© pasar√≠a si se fuera?
      #    ‚Üí La red se fragmenta en 3 componentes
      #    ‚Üí Log√≠stica queda aislada de Producci√≥n (casi totalmente)
      #    ‚Üí Solo quedar√≠a 1 conexi√≥n t√©cnica Producci√≥n-Calidad
      #
      # 3. ¬øLa organizaci√≥n lo sabe?
      #    ‚Üí Probablemente NO. "Coordinador de Despacho" suena operativo
      #    ‚Üí No es un cargo que normalmente se considera "estrat√©gico"
      #    ‚Üí En la mayor√≠a de empresas, esta persona no estar√≠a en el
      #      plan de sucesi√≥n ni tendr√≠a un backup entrenado

    test_cases:
      - id: test-identify-broker
        name: "Identificar al broker correctamente"
        description: "El broker es quien tiene mayor betweenness centrality"
        test_code: |
          G = nx.Graph()
          G.add_edges_from(all_edges)
          betweenness = nx.betweenness_centrality(G)
          broker = max(betweenness.items(), key=lambda x: x[1])
          assert broker[0] == "L-Coord", \
              f"El broker es L-Coord (Coord. Despacho), no {broker[0]}"
          assert broker[1] > 0.3, \
              f"El betweenness del broker debe ser >0.3, es {broker[1]:.3f}"
        points: 10

      - id: test-fragmentation
        name: "Detectar fragmentaci√≥n sin broker"
        description: "Sin el broker, la red debe fragmentarse"
        test_code: |
          G = nx.Graph()
          G.add_edges_from(all_edges)
          G.remove_node("L-Coord")
          components = list(nx.connected_components(G))
          assert len(components) >= 2, \
              f"Sin el broker debe haber 2+ componentes, hay {len(components)}"
        points: 10

      - id: test-cross-dept-connections
        name: "Verificar conexiones cross-departamento del broker"
        description: "El broker debe conectar al menos 2 departamentos diferentes"
        test_code: |
          broker_connections = [e for e in all_edges if "L-Coord" in e]
          depts_connected = set()
          for e in broker_connections:
              other = e[0] if e[1] == "L-Coord" else e[1]
              depts_connected.add(nodes[other]["dept"])
          depts_connected.add("logistica")  # Propio departamento
          assert len(depts_connected) >= 3, \
              f"El broker debe conectar 3 depts, conecta: {depts_connected}"
        points: 10

    hints:
      - level: 1
        text: "El broker no es necesariamente quien tiene m√°s conexiones (degree), sino quien est√° en el 'camino' entre grupos. Busca el nodo que, si lo quitas, desconecta partes de la red."
      - level: 2
        text: "Observa el gr√°fico de la derecha ('Si el broker se va'). ¬øCu√°ntos grupos separados ves? Eso te dice qu√© tan cr√≠tico es el broker."
      - level: 3
        text: "El broker est√° en Log√≠stica y tiene conexiones con Producci√≥n Y con Calidad. Mira las l√≠neas rojas/naranjas que salen del nodo rojo grande."

    tags:
      - ona
      - broker
      - betweenness
      - silos
      - riesgo-persona-clave

    concepts:
      - broker
      - betweenness-centrality
      - fragmentacion
      - riesgo-clave

# =============================================================================
# BLOQUE 3: CONSOLIDATION - QUIZ (25% ~ 6 min)
# 6 preguntas cubriendo Remember, Understand, Apply
# =============================================================================
quiz:
  id: quiz-01-organigrama-vs-red
  title: "Verificaci√≥n de comprensi√≥n: Organigrama vs Red"
  description: "Eval√∫a tu comprensi√≥n de los conceptos clave del cap√≠tulo"

  config:
    passing_score: 70
    show_feedback: true
    randomize_questions: false
    allow_retry: true

  questions:
    # --- NIVEL 1: REMEMBER (Definiciones b√°sicas) ---
    - id: Q1
      question: "¬øQu√© tipo de relaci√≥n captura el organigrama?"
      type: multiple_choice
      bloom_level: remember
      points: 10
      options:
        - id: a
          text: "Relaciones de reporte (qui√©n es jefe de qui√©n)"
        - id: b
          text: "Relaciones de consulta (a qui√©n piden ayuda)"
        - id: c
          text: "Relaciones de confianza (en qui√©n conf√≠an)"
        - id: d
          text: "Todas las relaciones de la organizaci√≥n"
      correct: a
      feedback_correct: |
        ‚úÖ Correcto. El organigrama solo captura la estructura formal de reporte.
        Las relaciones de consulta, confianza e informaci√≥n fluyen por redes
        informales que ONA puede mapear.
      feedback_incorrect: |
        ‚ùå El organigrama solo muestra relaciones de reporte formal.
        Las otras relaciones (consulta, confianza, informaci√≥n) son
        invisibles en el organigrama pero mapeables con ONA.

    - id: Q2
      question: "Un 'broker' en una red organizacional es alguien que:"
      type: multiple_choice
      bloom_level: remember
      points: 10
      options:
        - id: a
          text: "Tiene el cargo m√°s alto"
        - id: b
          text: "Conecta grupos que de otra forma estar√≠an aislados"
        - id: c
          text: "Tiene m√°s subordinados directos"
        - id: d
          text: "Lleva m√°s tiempo en la empresa"
      correct: b
      feedback_correct: |
        ‚úÖ Exacto. Un broker es alguien que sirve de puente entre grupos.
        Su valor est√° en la conectividad, no en la jerarqu√≠a.
      feedback_incorrect: |
        ‚ùå Un broker es quien conecta grupos que de otra forma no se
        comunicar√≠an. No tiene que ver con cargo, antig√ºedad o subordinados.

    # --- NIVEL 2: UNDERSTAND (Interpretaci√≥n) ---
    - id: Q3
      question: |
        En el caso de Manufactura Regional, el Analista QA Sr. era la persona
        m√°s consultada aunque estaba 3 niveles abajo del Director.
        ¬øQu√© concepto de ONA ilustra esto?
      type: multiple_choice
      bloom_level: understand
      points: 15
      options:
        - id: a
          text: "Que los organigramas est√°n mal dise√±ados"
        - id: b
          text: "Que la influencia informal no coincide con la jerarqu√≠a formal"
        - id: c
          text: "Que los analistas deber√≠an ser gerentes"
        - id: d
          text: "Que el Director no hace bien su trabajo"
      correct: b
      feedback_correct: |
        ‚úÖ Perfecto. Este es un hallazgo t√≠pico de ONA: la influencia real
        (qui√©n es consultado, qui√©n tiene informaci√≥n valiosa) rara vez
        coincide perfectamente con los niveles jer√°rquicos.
      feedback_incorrect: |
        ‚ùå Este caso ilustra que la influencia informal (basada en conocimiento
        y relaciones) opera independientemente de la jerarqu√≠a formal.
        No significa que el organigrama est√© "mal" - simplemente captura
        algo diferente a la red informal.

    - id: Q4
      question: |
        Si el Coord. de Despacho (broker) renunciara y nadie supiera que era
        un conector cr√≠tico, ¬øqu√© pasar√≠a probablemente?
      type: multiple_choice
      bloom_level: understand
      points: 15
      options:
        - id: a
          text: "Nada, su trabajo es operativo y f√°cil de reemplazar"
        - id: b
          text: "Los tres departamentos empezar√≠an a tener problemas de coordinaci√≥n sin entender por qu√©"
        - id: c
          text: "Solo Log√≠stica tendr√≠a problemas"
        - id: d
          text: "Se contratar√≠a un reemplazo inmediatamente porque es un cargo cr√≠tico"
      correct: b
      feedback_correct: |
        ‚úÖ Exacto. Este es el riesgo de no mapear redes: cuando un broker
        invisible se va, los s√≠ntomas (silos, falta de coordinaci√≥n, retrasos)
        aparecen pero nadie entiende la causa ra√≠z.
      feedback_incorrect: |
        ‚ùå Cuando un broker invisible se va, los problemas de coordinaci√≥n
        emergen gradualmente y sin explicaci√≥n obvia. La organizaci√≥n no
        sab√≠a que depend√≠a de esa persona para conectar departamentos.

    # --- NIVEL 3: APPLY (Aplicar a casos) ---
    - id: Q5
      question: |
        Tu CEO te pide: "Quiero saber por qu√© Marketing y Tecnolog√≠a nunca
        logran alinearse en los proyectos digitales."

        ¬øQu√© pregunta de encuesta ONA ser√≠a m√°s √∫til?
      type: multiple_choice
      bloom_level: apply
      points: 20
      options:
        - id: a
          text: "¬øCu√°ntas reuniones tienes al mes con otros departamentos?"
        - id: b
          text: "¬øCon qui√©n de FUERA de tu departamento te coordinas regularmente para proyectos digitales?"
        - id: c
          text: "¬øQu√© tan satisfecho est√°s con la colaboraci√≥n interdepartamental?"
        - id: d
          text: "¬øQui√©n es tu jefe directo?"
      correct: b
      feedback_correct: |
        ‚úÖ Excelente aplicaci√≥n. Esta pregunta mapear√≠a espec√≠ficamente los
        v√≠nculos (o la ausencia de ellos) entre Marketing y Tecnolog√≠a,
        revelando si hay brokers, silos o dependencias ocultas.
      feedback_incorrect: |
        ‚ùå La pregunta m√°s √∫til es la que mapea conexiones espec√≠ficas entre
        departamentos para proyectos digitales. Las otras preguntas dan
        informaci√≥n general pero no revelan la estructura de la red.

    - id: Q6
      question: |
        Analizas una red y encuentras que el 80% de las consultas t√©cnicas
        llegan a una sola persona que no tiene backup ni documentaci√≥n.

        ¬øCu√°l es la intervenci√≥n ONA m√°s apropiada?
      type: multiple_choice
      bloom_level: apply
      points: 20
      options:
        - id: a
          text: "Ascender a esa persona inmediatamente"
        - id: b
          text: "Documentar su conocimiento y crear conexiones secundarias (redundancia)"
        - id: c
          text: "Reducir sus responsabilidades para que tenga menos carga"
        - id: d
          text: "No hacer nada, claramente es muy competente"
      correct: b
      feedback_correct: |
        ‚úÖ Perfecta aplicaci√≥n del an√°lisis ONA. Cuando identificas un
        punto √∫nico de falla, la intervenci√≥n es crear redundancia:
        documentaci√≥n, entrenamiento cruzado y conexiones alternativas.
      feedback_incorrect: |
        ‚ùå Cuando ONA revela un "punto √∫nico de falla" (una persona de quien
        todos dependen), la intervenci√≥n correcta es crear redundancia:
        documentar su conocimiento y conectar a otros con las mismas fuentes.

# =============================================================================
# BLOQUE 4: CONCLUSIONS (10% ~ 2.5 min)
# S√≠ntesis activa + transferencia
# =============================================================================
conclusions:
  type: active_synthesis
  title: "S√≠ntesis y pr√≥ximo paso"

  # Actividad de s√≠ntesis (Teach-back)
  synthesis:
    type: teach_back
    prompt: |
      ## Tu turno: Expl√≠calo en una oraci√≥n

      Imagina que un colega te pregunta:

      > "¬øPara qu√© sirve el an√°lisis de redes si ya tenemos el organigrama?"

      **Escribe tu respuesta en una oraci√≥n** (m√°ximo 2 l√≠neas).
      Una buena respuesta incluye: qu√© revela ONA que el organigrama no puede.

    example_responses:
      - "ONA revela qui√©n realmente tiene influencia y conecta equipos, no solo qui√©n tiene el cargo."
      - "El organigrama muestra jefes; ONA muestra a qui√©n realmente consultan y qui√©n conecta silos."
      - "ONA mapea las relaciones informales que hacen que el trabajo fluya (o se frene)."

  # Action plan personal
  action_plan:
    prompt: |
      ## Pregunta para tu organizaci√≥n

      Piensa en tu empresa actual (o una que conozcas bien).

      **Identifica UNA pregunta que el organigrama no puede responder:**

      Ejemplos:
      - "¬øPor qu√© el equipo de [X] siempre est√° desalineado con [Y]?"
      - "¬øA qui√©n realmente consultan cuando hay un problema de [Z]?"
      - "¬øQu√© pasar√≠a si [persona clave] se fuera?"

      Esta pregunta ser√° tu caso de uso para el resto del curso.

  # Conexi√≥n hacia adelante (Chapter 2 preview)
  forward_connection:
    prompt: |
      ## Vista previa: Cap√≠tulo 2

      Ahora que puedes **ver** la red, el siguiente paso es **medirla**.

      En el pr√≥ximo cap√≠tulo aprender√°s 3 m√©tricas fundamentales:

      | M√©trica | Pregunta que responde |
      |---------|----------------------|
      | **Grado (Degree)** | ¬øQui√©n es m√°s consultado? |
      | **Intermediaci√≥n (Betweenness)** | ¬øQui√©n conecta silos? |
      | **Cercan√≠a (Closeness)** | ¬øQui√©n tiene acceso m√°s r√°pido a informaci√≥n? |

      **Predicci√≥n:** ¬øCu√°l de estas tres m√©tricas crees que es m√°s √∫til
      para identificar a un "experto oculto" como el Analista QA Sr.?

    prediction_options:
      - id: degree
        text: "Grado - porque es quien m√°s consultan"
      - id: betweenness
        text: "Intermediaci√≥n - porque conecta grupos"
      - id: closeness
        text: "Cercan√≠a - porque tiene acceso r√°pido"

    reveal_in_chapter: 2

# =============================================================================
# METADATA DE VERSI√ìN
# =============================================================================
version: "2.0"
last_updated: "2026-01-14"
model_applied: "4C-Bloom"
improvements:
  - "Agregado bloque CONNECTION con Misconception Check (4 afirmaciones)"
  - "Ejercicio 1 expandido: datos realistas 120 empleados, 3 departamentos"
  - "Ejercicio 2 expandido: visualizaci√≥n de fragmentaci√≥n si broker se va"
  - "Tests con assertions que validan comprensi√≥n, no solo ejecuci√≥n"
  - "Quiz de 6 preguntas cubriendo 3 niveles Bloom"
  - "Bloque CONCLUSIONS con s√≠ntesis activa y conexi√≥n forward"
  - "Hints progresivos en 3 niveles"
