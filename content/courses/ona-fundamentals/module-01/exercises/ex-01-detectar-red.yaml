# Ejercicio 1: Detectando la red oculta
# Manufactura Regional - 120 empleados, 3 departamentos
# Modelo 4C x Bloom - Version mejorada

id: ex-01-detectar-red
type: code-python
title: "Detectando la red oculta"
description: "Compara el organigrama formal con la red informal de consultas en Manufactura Regional."

instructions: |
  ## Caso: Manufactura Regional

  Estas analizando una planta de manufactura con **120 empleados** en **3 departamentos**:
  - **Produccion** (60 personas): Linea de ensamble, supervisores, tecnicos
  - **Calidad** (35 personas): Inspeccion, analisis, documentacion
  - **Logistica** (25 personas): Almacen, despacho, planeacion

  Se realizo una encuesta preguntando: *"A quien consultas cuando tienes un problema tecnico dificil?"*

  **Observa las dos visualizaciones:**
  - **Izquierda**: Fragmento del organigrama formal (jerarquia de reporte)
  - **Derecha**: Red de consultas tecnicas (quien consulta a quien)

  Los colores indican departamento:
  - Azul = Produccion
  - Verde = Calidad
  - Naranja = Logistica

  El **tamano del nodo** indica cuantas personas consultan a esa persona.

difficulty: beginner
estimated_time_minutes: 7
points: 30
order: 1

required_packages:
  - networkx
  - matplotlib
  - numpy

ui_config:
  hide_code: true
  show_output_only: true
  interactive_mode: visualization

starter_code: |
  import networkx as nx
  import matplotlib.pyplot as plt
  import numpy as np

  # ===========================================
  # DATOS: Manufactura Regional (120 empleados)
  # ===========================================

  # --- ORGANIGRAMA (estructura jerarquica simplificada) ---
  org_nodes = {
      "Dir. Planta": {"dept": "direccion", "level": 0},
      "Gte. Produccion": {"dept": "produccion", "level": 1},
      "Gte. Calidad": {"dept": "calidad", "level": 1},
      "Gte. Logistica": {"dept": "logistica", "level": 1},
      "Sup. Linea A": {"dept": "produccion", "level": 2},
      "Sup. Linea B": {"dept": "produccion", "level": 2},
      "Jefe QA": {"dept": "calidad", "level": 2},
      "Jefe Documentacion": {"dept": "calidad", "level": 2},
      "Jefe Almacen": {"dept": "logistica", "level": 2},
      "Tecnico Senior": {"dept": "produccion", "level": 3},
      "Operador A1": {"dept": "produccion", "level": 3},
      "Analista QA Sr.": {"dept": "calidad", "level": 3},
      "Inspector 1": {"dept": "calidad", "level": 3},
      "Coord. Despacho": {"dept": "logistica", "level": 3},
      "Almacenista Sr.": {"dept": "logistica", "level": 3},
  }

  org_edges = [
      ("Dir. Planta", "Gte. Produccion"),
      ("Dir. Planta", "Gte. Calidad"),
      ("Dir. Planta", "Gte. Logistica"),
      ("Gte. Produccion", "Sup. Linea A"),
      ("Gte. Produccion", "Sup. Linea B"),
      ("Gte. Calidad", "Jefe QA"),
      ("Gte. Calidad", "Jefe Documentacion"),
      ("Gte. Logistica", "Jefe Almacen"),
      ("Sup. Linea A", "Tecnico Senior"),
      ("Sup. Linea A", "Operador A1"),
      ("Jefe QA", "Analista QA Sr."),
      ("Jefe QA", "Inspector 1"),
      ("Jefe Almacen", "Coord. Despacho"),
      ("Jefe Almacen", "Almacenista Sr."),
  ]

  # --- RED DE CONSULTAS (quien consulta a quien) ---
  network_edges = [
      ("Sup. Linea A", "Analista QA Sr."),
      ("Sup. Linea B", "Analista QA Sr."),
      ("Tecnico Senior", "Analista QA Sr."),
      ("Operador A1", "Analista QA Sr."),
      ("Jefe Almacen", "Analista QA Sr."),
      ("Coord. Despacho", "Analista QA Sr."),
      ("Inspector 1", "Analista QA Sr."),
      ("Gte. Produccion", "Analista QA Sr."),
      ("Jefe Documentacion", "Analista QA Sr."),
      ("Operador A1", "Tecnico Senior"),
      ("Sup. Linea B", "Sup. Linea A"),
      ("Almacenista Sr.", "Coord. Despacho"),
      ("Coord. Despacho", "Tecnico Senior"),
      ("Jefe QA", "Analista QA Sr."),
  ]

  dept_colors = {
      "direccion": "#95a5a6",
      "produccion": "#3498db",
      "calidad": "#2ecc71",
      "logistica": "#e67e22",
  }

  # ===========================================
  # VISUALIZACION COMPARATIVA
  # ===========================================
  fig, axes = plt.subplots(1, 2, figsize=(16, 8))

  # --- GRAFICO 1: ORGANIGRAMA ---
  G_org = nx.DiGraph()
  G_org.add_edges_from(org_edges)

  pos_org = {}
  level_count = {0: 0, 1: 0, 2: 0, 3: 0}
  level_max = {0: 1, 1: 3, 2: 5, 3: 6}

  for node, attrs in org_nodes.items():
      level = attrs["level"]
      y = 3 - level
      x = level_count[level] - (level_max[level] - 1) / 2
      pos_org[node] = (x * 1.5, y * 1.2)
      level_count[level] += 1

  node_colors_org = [dept_colors[org_nodes[n]["dept"]] for n in G_org.nodes()]

  nx.draw(G_org, pos_org, ax=axes[0],
          with_labels=True,
          node_color=node_colors_org,
          node_size=1800,
          font_size=7,
          font_weight='bold',
          arrows=True,
          arrowsize=15,
          edge_color='#bdc3c7',
          width=1.5)
  axes[0].set_title("ORGANIGRAMA FORMAL\n(Quien reporta a quien)",
                    fontsize=14, fontweight='bold', pad=20)

  # --- GRAFICO 2: RED DE CONSULTAS ---
  G_net = nx.Graph()
  G_net.add_nodes_from(org_nodes.keys())
  G_net.add_edges_from(network_edges)

  degrees = dict(G_net.degree())
  max_degree = max(degrees.values())
  node_sizes = [800 + (degrees[n] / max_degree) * 2500 for n in G_net.nodes()]

  node_colors_net = []
  for n in G_net.nodes():
      if degrees[n] == max_degree:
          node_colors_net.append("#e74c3c")
      else:
          node_colors_net.append(dept_colors[org_nodes[n]["dept"]])

  pos_net = nx.spring_layout(G_net, k=2.5, iterations=50, seed=42)

  nx.draw(G_net, pos_net, ax=axes[1],
          with_labels=True,
          node_color=node_colors_net,
          node_size=node_sizes,
          font_size=7,
          font_weight='bold',
          edge_color='#bdc3c7',
          width=1.5,
          alpha=0.9)
  axes[1].set_title("RED DE CONSULTAS TECNICAS\n(Quien consulta a quien)",
                    fontsize=14, fontweight='bold', pad=20)

  legend_elements = [
      plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#3498db',
                 markersize=12, label='Produccion'),
      plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#2ecc71',
                 markersize=12, label='Calidad'),
      plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#e67e22',
                 markersize=12, label='Logistica'),
      plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#e74c3c',
                 markersize=15, label='Mas consultado'),
  ]
  fig.legend(handles=legend_elements, loc='lower center', ncol=4,
             fontsize=10, frameon=True, fancybox=True)

  plt.tight_layout(rect=[0, 0.08, 1, 1])
  plt.show()

  # ===========================================
  # METRICAS CLAVE
  # ===========================================
  print("\n" + "="*60)
  print("METRICAS DE LA RED DE CONSULTAS")
  print("="*60)

  top_consultados = sorted(degrees.items(), key=lambda x: x[1], reverse=True)[:5]
  print("\nTop 5 personas mas consultadas:")
  for i, (nombre, grado) in enumerate(top_consultados, 1):
      dept = org_nodes[nombre]["dept"].capitalize()
      level = org_nodes[nombre]["level"]
      nivel_org = ["Director", "Gerente", "Jefe/Supervisor", "Tecnico/Analista"][level]
      marker = ">>> " if i == 1 else "    "
      print(f"{marker}{i}. {nombre} ({dept}) - {grado} consultas - Nivel: {nivel_org}")

  betweenness = nx.betweenness_centrality(G_net)
  top_broker = max(betweenness.items(), key=lambda x: x[1])

  print(f"\nMayor intermediacion (broker potencial):")
  print(f"    {top_broker[0]} (betweenness: {top_broker[1]:.3f})")

solution_code: |
  # RESPUESTAS CORRECTAS:
  #
  # 1. Persona mas consultada: "Analista QA Sr." (10 conexiones)
  #    - En el organigrama esta en nivel 3 (el mas bajo mostrado)
  #    - Reporta al Jefe QA, que reporta al Gte. Calidad
  #    - Sin embargo, es consultado por TODOS los departamentos
  #
  # 2. Diferencia jerarquica vs red:
  #    - Organigrama: Analista QA Sr. esta 3 niveles abajo del Director
  #    - Red real: Es el nodo mas central y conectado
  #
  # 3. Riesgo si se va:
  #    - Produccion perderia su fuente de conocimiento tecnico de calidad
  #    - Logistica perderia consultas sobre especificaciones
  #    - El Jefe QA perderia a quien realmente resuelve los problemas

test_cases:
  - id: test-identify-most-consulted
    name: "Identificar persona mas consultada"
    description: "El estudiante debe identificar al Analista QA Sr. como el mas consultado"
    test_code: |
      G = nx.Graph()
      G.add_nodes_from(org_nodes.keys())
      G.add_edges_from(network_edges)
      degrees = dict(G.degree())
      most_consulted = max(degrees.items(), key=lambda x: x[1])
      assert most_consulted[0] == "Analista QA Sr.", \
          f"El mas consultado es 'Analista QA Sr.', no '{most_consulted[0]}'"
    points: 10

  - id: test-hierarchy-gap
    name: "Detectar brecha jerarquia vs influencia"
    description: "El estudiante debe reconocer que el mas consultado NO es un gerente"
    test_code: |
      most_consulted = "Analista QA Sr."
      org_level = org_nodes[most_consulted]["level"]
      assert org_level == 3, \
          f"El Analista QA Sr. esta en nivel {org_level}, el mas bajo (3)"
      assert ("Jefe QA", "Analista QA Sr.") in network_edges, \
          "El Jefe QA consulta a su subordinado - inversion jerarquica"
    points: 10

  - id: test-cross-department
    name: "Identificar consultas cross-departamento"
    description: "El estudiante debe notar que Produccion y Logistica consultan a Calidad"
    test_code: |
      consultantes = [e[0] for e in network_edges if e[1] == "Analista QA Sr."]
      depts_consultantes = set([org_nodes[c]["dept"] for c in consultantes])
      assert "produccion" in depts_consultantes, \
          "Produccion debe consultar al Analista QA Sr."
      assert "logistica" in depts_consultantes, \
          "Logistica debe consultar al Analista QA Sr."
    points: 10

hints:
  - "Observa el nodo marcado en ROJO en la red de consultas. Cuantas lineas llegan a el?"
  - "Ahora busca ese mismo nombre en el organigrama de la izquierda. En que nivel esta?"
  - "Fijate que personas de TODOS los colores consultan al nodo rojo. Incluso su propio jefe."

tags:
  - ona
  - visualizacion
  - organigrama
  - red-informal
  - experto-oculto

concepts:
  - red-informal
  - estructura-formal
  - experto-oculto
  - centralidad-grado
