# Ejercicio 8: An√°lisis de riesgo por dependencia de personas clave
# Tipo: code-python (c√≥digo oculto)

id: ex-08-riesgo-dependencia
type: code-python
title: "Riesgo de dependencia"
description: "Identifica personas clave cuya salida impactar√≠a severamente la red."

instructions: |
  **Contexto:**
  El √°rea de Recursos Humanos quiere identificar "key person risk" - personas
  cuya salida repentina causar√≠a disrupciones significativas.

  **Los datos muestran:**
  - Red de 15 empleados en un equipo de tecnolog√≠a
  - El tama√±o de cada nodo representa su centralidad de intermediaci√≥n
  - El color indica el nivel de riesgo

  **Tu tarea:**
  1. Identifica las 2 personas con mayor riesgo de dependencia
  2. Explica por qu√© su salida ser√≠a problem√°tica
  3. Prop√≥n una estrategia de mitigaci√≥n

difficulty: intermediate
estimated_time_minutes: 12
points: 35
order: 8

required_packages:
  - networkx
  - matplotlib
  - pandas
  - numpy

ui_config:
  hide_code: true
  show_output_only: true
  interactive_mode: visualization

starter_code: |
  import networkx as nx
  import matplotlib.pyplot as plt
  import pandas as pd
  import numpy as np

  # Crear red con estructura de dependencia
  G = nx.Graph()

  # Empleados con roles
  empleados = {
      'Ana': 'Tech Lead',
      'Bruno': 'Senior Dev',
      'Carlos': 'Dev',
      'Diana': 'Dev',
      'Elena': 'QA Lead',
      'Felipe': 'QA',
      'Gloria': 'DevOps',
      'Hugo': 'Dev',
      'Isabel': 'Dev',
      'Juan': 'Junior',
      'Karen': 'Junior',
      'Luis': 'Junior',
      'Mar√≠a': 'Arquitecta',
      'Nicol√°s': 'PM',
      'Oscar': 'Designer'
  }

  for emp, rol in empleados.items():
      G.add_node(emp, rol=rol)

  # Conexiones que crean dependencias
  edges = [
      # Mar√≠a (Arquitecta) es consultada por MUCHOS para decisiones t√©cnicas
      ('Mar√≠a', 'Ana'), ('Mar√≠a', 'Bruno'), ('Mar√≠a', 'Carlos'),
      ('Mar√≠a', 'Diana'), ('Mar√≠a', 'Gloria'), ('Mar√≠a', 'Hugo'),
      # Ana (Tech Lead) coordina el equipo de desarrollo
      ('Ana', 'Bruno'), ('Ana', 'Carlos'), ('Ana', 'Diana'),
      ('Ana', 'Hugo'), ('Ana', 'Isabel'),
      # Gloria (DevOps) es el √öNICO punto de contacto para infra
      ('Gloria', 'Ana'), ('Gloria', 'Elena'), ('Gloria', 'Bruno'),
      ('Gloria', 'Nicol√°s'),
      # Elena coordina QA
      ('Elena', 'Felipe'), ('Elena', 'Ana'),
      # Nicol√°s (PM) conecta con stakeholders
      ('Nicol√°s', 'Ana'), ('Nicol√°s', 'Elena'), ('Nicol√°s', 'Oscar'),
      # Conexiones de juniors (dependen de seniors)
      ('Juan', 'Bruno'), ('Karen', 'Carlos'), ('Luis', 'Diana'),
      # Conexiones laterales
      ('Bruno', 'Carlos'), ('Carlos', 'Diana'), ('Hugo', 'Isabel'),
      ('Felipe', 'Oscar'),
  ]

  G.add_edges_from(edges)

  # Calcular m√©tricas de riesgo
  betweenness = nx.betweenness_centrality(G)
  degree = dict(G.degree())

  # Crear DataFrame de riesgo
  df_riesgo = pd.DataFrame({
      'Empleado': list(empleados.keys()),
      'Rol': list(empleados.values()),
      'Conexiones': [degree[e] for e in empleados.keys()],
      'Intermediaci√≥n': [round(betweenness[e], 3) for e in empleados.keys()]
  })

  # Calcular score de riesgo (combinaci√≥n de m√©tricas)
  df_riesgo['Score_Riesgo'] = (
      df_riesgo['Intermediaci√≥n'] * 0.7 +
      (df_riesgo['Conexiones'] / df_riesgo['Conexiones'].max()) * 0.3
  ).round(3)

  df_riesgo = df_riesgo.sort_values('Score_Riesgo', ascending=False)

  # Clasificar nivel de riesgo
  def clasificar_riesgo(score):
      if score >= 0.4:
          return 'üî¥ CR√çTICO'
      elif score >= 0.2:
          return 'üü° ALTO'
      elif score >= 0.1:
          return 'üü¢ MEDIO'
      else:
          return '‚ö™ BAJO'

  df_riesgo['Nivel'] = df_riesgo['Score_Riesgo'].apply(clasificar_riesgo)

  # Visualizaci√≥n
  fig, axes = plt.subplots(1, 2, figsize=(16, 8))

  # Gr√°fico de red con tama√±o por riesgo
  pos = nx.spring_layout(G, k=2, seed=42)

  # Colores por nivel de riesgo
  def color_riesgo(emp):
      score = df_riesgo[df_riesgo['Empleado'] == emp]['Score_Riesgo'].values[0]
      if score >= 0.4:
          return '#e74c3c'  # Rojo
      elif score >= 0.2:
          return '#f1c40f'  # Amarillo
      elif score >= 0.1:
          return '#2ecc71'  # Verde
      else:
          return '#bdc3c7'  # Gris

  node_colors = [color_riesgo(n) for n in G.nodes()]
  node_sizes = [1000 + betweenness[n] * 5000 for n in G.nodes()]

  nx.draw(G, pos, ax=axes[0], with_labels=True,
          node_color=node_colors, node_size=node_sizes,
          font_size=9, font_weight='bold', edge_color='gray', alpha=0.8)
  axes[0].set_title("Red de Consultas\n(Tama√±o = Intermediaci√≥n, Color = Riesgo)",
                    fontsize=12, fontweight='bold')

  # Leyenda
  legend_elements = [
      plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#e74c3c',
                 markersize=15, label='Cr√≠tico'),
      plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#f1c40f',
                 markersize=15, label='Alto'),
      plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#2ecc71',
                 markersize=15, label='Medio'),
      plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='#bdc3c7',
                 markersize=15, label='Bajo'),
  ]
  axes[0].legend(handles=legend_elements, loc='upper left', title='Nivel de Riesgo')

  # Tabla de riesgo (top 8)
  axes[1].axis('off')
  top_riesgo = df_riesgo.head(8)[['Empleado', 'Rol', 'Conexiones', 'Intermediaci√≥n', 'Nivel']]

  table = axes[1].table(
      cellText=top_riesgo.values,
      colLabels=top_riesgo.columns,
      cellLoc='center',
      loc='center',
      colColours=['#f0f0f0']*5
  )
  table.auto_set_font_size(False)
  table.set_fontsize(10)
  table.scale(1.2, 2)
  axes[1].set_title("Top 8 - Riesgo de Dependencia", fontsize=12, fontweight='bold', pad=20)

  plt.tight_layout()
  plt.show()

  # An√°lisis
  print("\n" + "="*60)
  print("AN√ÅLISIS DE RIESGO DE DEPENDENCIA")
  print("="*60)

  criticos = df_riesgo[df_riesgo['Score_Riesgo'] >= 0.4]
  print(f"\nüî¥ PERSONAS EN RIESGO CR√çTICO: {len(criticos)}")
  for _, row in criticos.iterrows():
      print(f"   ‚Ä¢ {row['Empleado']} ({row['Rol']})")
      print(f"     Intermediaci√≥n: {row['Intermediaci√≥n']:.3f}")
      print(f"     Conexiones: {row['Conexiones']}")

  print("\n" + "="*60)
  print("PREGUNTA DE AN√ÅLISIS")
  print("="*60)
  print("\n¬øCu√°l de estas estrategias es M√ÅS efectiva para mitigar")
  print("el riesgo de dependencia de Mar√≠a (Arquitecta)?")
  print("\nOpciones:")
  print("A) Aumentar su salario para retenerla")
  print("B) Documentar sus decisiones y crear sesiones de transferencia")
  print("C) Prohibir que otros la consulten directamente")
  print("D) Contratar otra arquitecta como respaldo")

solution_code: |
  # Respuesta correcta: B) Documentar y transferir conocimiento
  #
  # Por qu√©:
  # - Opci√≥n A: No reduce la dependencia, solo intenta evitar salida
  # - Opci√≥n B: Distribuye el conocimiento, reduce la intermediaci√≥n
  # - Opci√≥n C: No es viable y crear√≠a m√°s problemas
  # - Opci√≥n D: Costoso y no garantiza transferencia
  #
  # Estrategia completa de mitigaci√≥n:
  # 1. Documentar decisiones arquitect√≥nicas (ADRs)
  # 2. Crear "Architecture Guild" con Bruno, Ana y otros
  # 3. Sesiones mensuales de transferencia
  # 4. Rotar personas en decisiones arquitect√≥nicas
  # 5. Pair programming en decisiones cr√≠ticas

test_cases:
  - id: test-risk-analysis
    name: "An√°lisis de riesgo completado"
    test_code: |
      assert True, "An√°lisis ejecutado correctamente"
    points: 35

hints:
  - "Los nodos m√°s grandes tienen mayor intermediaci√≥n"
  - "El riesgo cr√≠tico indica que muchos flujos pasan por esa persona"
  - "La mitigaci√≥n debe reducir la dependencia, no solo retener a la persona"

tags:
  - ona
  - key-person-risk
  - talento
  - mitigacion

concepts:
  - riesgo-dependencia
  - plan-sucesion
  - transferencia-conocimiento

# Preguntas interactivas mostradas despu√©s de la visualizaci√≥n
comprehension_questions:
  - id: cq-01-personas-criticas
    question: "¬øQui√©n tiene el nivel de riesgo m√°s CR√çTICO seg√∫n el an√°lisis?"
    options:
      - id: a
        text: "Ana (Tech Lead)"
      - id: b
        text: "Gloria (DevOps)"
      - id: c
        text: "Mar√≠a (Arquitecta)"
      - id: d
        text: "Nicol√°s (PM)"
    correct: c
    feedback_correct: "¬°Correcto! Mar√≠a tiene la intermediaci√≥n m√°s alta porque TODOS consultan sus decisiones arquitect√≥nicas. Su salida impactar√≠a las decisiones t√©cnicas de todo el equipo."
    feedback_incorrect: "Observa la tabla de riesgo - busca qui√©n tiene el Score m√°s alto y el nivel 'üî¥ CR√çTICO'."

  - id: cq-02-razon-critico
    question: "¬øPor qu√© Mar√≠a es cr√≠tica si no es la que tiene m√°s conexiones?"
    options:
      - id: a
        text: "Tiene el cargo m√°s alto del equipo"
      - id: b
        text: "Muchos flujos de informaci√≥n pasan por ella (alta intermediaci√≥n)"
      - id: c
        text: "Es la √∫nica mujer senior del equipo"
      - id: d
        text: "Trabaja m√°s horas que los dem√°s"
    correct: b
    feedback_correct: "¬°Exacto! La intermediaci√≥n alta significa que Mar√≠a est√° en el 'camino' de muchas decisiones. Aunque otros tengan m√°s conexiones, ella es punto de paso obligatorio."
    feedback_incorrect: "El riesgo de dependencia se mide principalmente por la intermediaci√≥n (betweenness), no por el n√∫mero de conexiones."

  - id: cq-03-mitigacion
    question: "¬øCu√°l es la estrategia m√°s efectiva para mitigar el riesgo de Mar√≠a?"
    options:
      - id: a
        text: "Aumentar su salario para retenerla"
      - id: b
        text: "Documentar decisiones y crear sesiones de transferencia de conocimiento"
      - id: c
        text: "Prohibir que otros la consulten directamente"
      - id: d
        text: "Contratar otra arquitecta como respaldo"
    correct: b
    feedback_correct: "¬°Correcto! Documentar y transferir conocimiento distribuye la expertise. Las otras opciones no reducen la dependencia real - solo intentan evitar la salida o duplicar costos."
    feedback_incorrect: "La mitigaci√≥n debe REDUCIR la dependencia, no solo evitar que la persona se vaya."
